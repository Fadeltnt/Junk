Private Sub GenererApercuXml(obj As Object)
    Try
        ' Création du XML avec les informations saisies et les variables
        Dim xmlDoc As New XDocument(
            New XDeclaration("1.0", "utf-8", "yes"),
            New XElement("memo",
                New XElement("champ", Champ1),
                New XElement("communication",
                    New XElement("champ", Champ2)
                ),
                New XElement("IdRef", Champ3),
                New XElement("CodeSujet", CodeSujet),
                New XElement("paragraphes",
                    From code In _codesG4
                    Let parts = code.Split("|"c)
                    Let numero = parts(0) ' Déclaration de 'numero'
                    Let variable = If(parts.Length > 1, parts(1), String.Empty)

                    ' Récupération des variables automatiques et fixes
                    Let variablesXmlElement = If(Not String.IsNullOrEmpty(variable),
                        New XElement("numero", variable),
                        Nothing
                    )

                    Let variablesFixesXmlElement = If(_variablesFixes.ContainsKey(numero),
                        New XElement("numero", _variablesFixes(numero)),
                        Nothing
                    )

                    ' Création de l'élément <Variables> en tenant compte des conditions
                    Let finalVariablesElement = 
                        If(variablesXmlElement IsNot Nothing OrElse variablesFixesXmlElement IsNot Nothing,
                            New XElement("Variables",
                                variablesXmlElement,
                                variablesFixesXmlElement
                            ),
                            New XElement("Variables") ' Si aucune variable, affiche juste <Variables/>
                        )

                    ' Sélection de l'élément paragraphe avec ou sans variables
                    Select New XElement("paragraphe",
                        New XElement("numero", numero),
                        finalVariablesElement
                    )
                ),
                New XElement("divers", "")
            )
        )

        ' Mise à jour de l'aperçu XML avec indentation
        Dim settings As New XmlWriterSettings() With {
            .Indent = True,
            .Encoding = New System.Text.UTF8Encoding(False)
        }

        Using sw As New StringWriter()
            Using xw As XmlWriter = XmlWriter.Create(sw, settings)
                xmlDoc.Save(xw)
            End Using
            ApercuXml = sw.ToString()
        End Using

        ' Mise à jour de la liste des paragraphes après génération
        _listeParagraphes.Clear()
        _listeParagraphes.AddRange(_codesG4)
        OnPropertyChanged("ListeParagraphes")

        ' Réinitialisation des valeurs après la génération
        _codesG4.Clear()
        _codeSujet = String.Empty

    Catch ex As Exception
        ApercuXml = "❌ Erreur lors de la génération : " & ex.Message
    End Try
End Sub
