Private Sub GenererApercuXml(obj As Object)
    Try
        ' Création du XML avec les informations saisies et les variables
        Dim xmlDoc As New XDocument(
            New XDeclaration("1.0", "utf-8", "yes"),
            New XElement("memo",
                New XElement("champ", Champ1),
                New XElement("communication",
                    New XElement("champ", Champ2)
                ),
                New XElement("IdRef", Champ3),
                New XElement("CodeSujet", CodeSujet),
                New XElement("paragraphes",
                    From code In _codesG4
                    Let parts = code.Split("|"c)
                    Let numero = parts(0) ' Déclaration de 'numero'
                    Let variable = If(parts.Length > 1, parts(1), String.Empty)

                    ' Création du bloc Variables pour les variables automatiques
                    Let variablesAutomatiques = If(Not String.IsNullOrEmpty(variable),
                        New XElement("Variables",
                            New XElement("numero", variable)
                        ),
                        Nothing
                    )

                    ' Création du bloc Variables pour les variables fixes
                    Let variablesFixes = If(_variablesFixes.ContainsKey(numero),
                        New XElement("Variables",
                            New XElement("numero", _variablesFixes(numero)),
                            New XElement("valeur", "VariableFixe" & _variablesFixes(numero))
                        ),
                        Nothing
                    )

                    ' Gestion des cas :
                    ' - Si les deux sont présents -> Deux blocs <Variables>
                    ' - Si un seul est présent -> Un seul bloc <Variables>
                    ' - Si aucun n'est présent -> <Variables/>
                    Let variablesElements = New List(Of XElement)()
                    If variablesAutomatiques IsNot Nothing Then
                        variablesElements.Add(variablesAutomatiques)
                    End If
                    If variablesFixes IsNot Nothing Then
                        variablesElements.Add(variablesFixes)
                    End If
                    If variablesElements.Count = 0 Then
                        variablesElements.Add(New XElement("Variables"))
                    End If

                    ' Sélection de l'élément paragraphe avec les blocs Variables
                    Select New XElement("paragraphe",
                        New XElement("numero", numero),
                        variablesElements
                    )
                ),
                New XElement("divers", "")
            )
        )

        ' Mise à jour de l'aperçu XML avec indentation
        Dim settings As New XmlWriterSettings() With {
            .Indent = True,
            .Encoding = New System.Text.UTF8Encoding(False)
        }

        Using sw As New StringWriter()
            Using xw As XmlWriter = XmlWriter.Create(sw, settings)
                xmlDoc.Save(xw)
            End Using
            ApercuXml = sw.ToString()
        End Using

        ' Mise à jour de la liste des paragraphes après génération
        _listeParagraphes.Clear()
        _listeParagraphes.AddRange(_codesG4)
        OnPropertyChanged("ListeParagraphes")

        ' Réinitialisation des valeurs après la génération
        _codesG4.Clear()
        _codeSujet = String.Empty

    Catch ex As Exception
        ApercuXml = "❌ Erreur lors de la génération : " & ex.Message
    End Try
End Sub
